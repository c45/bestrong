trigger: 
  branches:
    include:
      - master
  paths:
    include:
      - dev    

pool: 
    vmImage: ubuntu-latest

variables:
  workdir: /home/vsts/work/1/s/dev

steps:
- task: TerraformInstaller@0
  displayName: Install Terraform
  inputs:
    terraformVersion: 'v1.5.2'

- checkout: self
  displayName: Checkout Repository   
- task: TerraformCLI@0
  displayName: Terraform Init
  inputs:
    command: 'init'
    workingDirectory: '$(workdir)'
    backendType: 'azurerm'
    backendServiceArm: 'PipelineConnection'
    backendAzureRmSubscriptionId: $(subscription_id)
- task: TerraformCLI@0
  displayName: Terraform Validate
  inputs:
    command: 'validate'
    workingDirectory: '$(workdir)'
- task: TerraformCLI@0
  displayName: Terraform Plan
  inputs:
    command: 'plan'
    workingDirectory: '$(workdir)'
    environmentServiceName: 'PipelineConnection'
    providerAzureRmSubscriptionId: $(subscription_id)
    publishPlanResults: 'tfplan'
- task: TerraformCLI@0
  displayName: Terraform Apply
  inputs:
    command: 'apply'
    environmentServiceName: 'PipelineConnection'
    providerAzureRmSubscriptionId: '$(subscription_id)'
    commandOptions: 'tfplan'
    allowTelemetryCollection: false

    